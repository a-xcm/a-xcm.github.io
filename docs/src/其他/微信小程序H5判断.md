# 微信小程序H5判断

## 概述
本文档介绍如何在H5页面中判断是否运行在微信小程序的webview环境中，并提供相关操作方法。

## 核心判断方法

### 基本判断
```javascript
const ua = navigator.userAgent.toLowerCase();
if ((ua.includes('miniprogram') && !ua.includes('alipay')) 
|| (typeof wx !== 'undefined' && wx.miniProgram)) {
    console.log('当前在微信小程序环境中');
}
```

### 完整判断函数

```javascript
/**
 * 判断是否在微信小程序环境中
 * @returns {boolean} 是否在微信小程序环境
 */
function isWeChatMiniProgram() {
    // 获取用户代理字符串
    const ua = navigator.userAgent.toLowerCase();
    
    // 检查userAgent中是否包含miniprogram标识且排除支付宝
    const hasMiniProgramUA = ua.includes('miniprogram') && !ua.includes('alipay');
    
    // 检查是否存在wx对象且包含miniProgram属性
    const hasWxMiniProgram = typeof wx !== 'undefined' && wx.miniProgram;
    
    return hasMiniProgramUA || hasWxMiniProgram;
}
```

## 常用操作方法

### 页面导航

```javascript
// 返回上一页
if (isWeChatMiniProgram()) {
    wx.miniProgram.navigateBack();
}

// 跳转到指定页面
if (isWeChatMiniProgram()) {
    wx.miniProgram.navigateTo({
        url: '/pages/index/index'
    });
}

// 重定向到指定页面
if (isWeChatMiniProgram()) {
    wx.miniProgram.redirectTo({
        url: '/pages/index/index'
    });
}
```

### 获取小程序信息

```javascript
if (isWeChatMiniProgram()) {
    // 获取小程序版本号
    wx.miniProgram.getEnv(function(res) {
        console.log('小程序环境:', res.miniprogram);
    });
}
```

## 高级应用

### 环境判断与适配

```javascript
/**
 * 获取当前运行环境
 * @returns {string} 环境类型: 'wechat-miniprogram' | 'browser' | 'other'
 */
function getCurrentEnvironment() {
    if (isWeChatMiniProgram()) {
        return 'wechat-miniprogram';
    }
    
    // 检查是否在浏览器环境
    if (typeof window !== 'undefined' && window.navigator) {
        return 'browser';
    }
    
    return 'other';
}

// 根据环境执行不同逻辑
function initApp() {
    const env = getCurrentEnvironment();
    
    switch (env) {
        case 'wechat-miniprogram':
            console.log('初始化小程序环境');
            // 小程序特定逻辑
            break;
        case 'browser':
            console.log('初始化浏览器环境');
            // 浏览器特定逻辑
            break;
        default:
            console.log('初始化其他环境');
            // 通用逻辑
            break;
    }
}
```

### 微信API调用封装

```javascript
/**
 * 安全调用微信小程序API
 * @param {string} method API方法名
 * @param {Object} options API参数
 * @returns {Promise} 返回Promise对象
 */
function callWeChatAPI(method, options = {}) {
    return new Promise((resolve, reject) => {
        if (!isWeChatMiniProgram() || !wx[method]) {
            reject(new Error('当前环境不支持该API'));
            return;
        }
        
        wx[method]({
            ...options,
            success: resolve,
            fail: reject
        });
    });
}

// 使用示例
async function navigateToPage(url) {
    try {
        await callWeChatAPI('miniProgram.navigateTo', { url });
        console.log('跳转成功');
    } catch (error) {
        console.error('跳转失败:', error);
    }
}
```

## 注意事项

1. **兼容性问题**
   - 不同版本的微信小程序可能对webview的支持有所差异
   - 部分旧版本微信可能不包含miniprogram标识

2. **安全性**
   - 避免在H5页面中直接存储敏感信息
   - 调用微信API时注意权限问题

3. **性能优化**
   - 环境判断逻辑应在页面初始化时执行，避免重复判断
   - 对于频繁调用的API，建议进行缓存处理

4. **测试建议**
   - 在真实的微信小程序环境中进行测试
   - 测试不同版本微信的兼容性
   - 测试不同机型的表现

## 浏览器兼容性

| 浏览器/环境 | 支持情况 | 备注 |
|------------|----------|------|
| 微信小程序webview | ✅ 完全支持 | 核心使用场景 |
| 微信浏览器 | ✅ 支持 | 可正常检测 |
| Chrome | ✅ 支持 | 可正常检测 |
| Firefox | ✅ 支持 | 可正常检测 |
| Safari | ✅ 支持 | 可正常检测 |
| 其他主流浏览器 | ✅ 支持 | 可正常检测 |

## 最佳实践

1. **统一管理环境判断**
   - 创建专门的环境检测模块
   - 提供统一的API接口

2. **优雅降级**
   - 在非小程序环境中提供替代方案
   - 确保页面在不同环境中都能正常运行

3. **代码组织**
   - 将环境相关逻辑与业务逻辑分离
   - 使用模块化方式管理代码

4. **文档化**
   - 记录环境判断逻辑和使用方法
   - 为团队成员提供参考文档

## 完整示例

### 环境检测模块

```javascript
// env-detector.js
class EnvDetector {
    /**
     * 判断是否在微信小程序环境中
     */
    static isWeChatMiniProgram() {
        const ua = navigator.userAgent.toLowerCase();
        const hasMiniProgramUA = ua.includes('miniprogram') && !ua.includes('alipay');
        const hasWxMiniProgram = typeof wx !== 'undefined' && wx.miniProgram;
        return hasMiniProgramUA || hasWxMiniProgram;
    }
    
    /**
     * 判断是否在支付宝小程序环境中
     */
    static isAlipayMiniProgram() {
        const ua = navigator.userAgent.toLowerCase();
        return ua.includes('miniprogram') && ua.includes('alipay');
    }
    
    /**
     * 获取当前运行环境
     */
    static getCurrentEnvironment() {
        if (this.isWeChatMiniProgram()) {
            return 'wechat-miniprogram';
        }
        
        if (this.isAlipayMiniProgram()) {
            return 'alipay-miniprogram';
        }
        
        if (typeof window !== 'undefined' && window.navigator) {
            return 'browser';
        }
        
        return 'other';
    }
    
    /**
     * 安全调用微信小程序API
     */
    static callWeChatAPI(method, options = {}) {
        return new Promise((resolve, reject) => {
            if (!this.isWeChatMiniProgram() || !wx[method]) {
                reject(new Error('当前环境不支持该API'));
                return;
            }
            
            wx[method]({
                ...options,
                success: resolve,
                fail: reject
            });
        });
    }
}

// 导出模块
if (typeof module !== 'undefined' && module.exports) {
    module.exports = EnvDetector;
} else if (typeof window !== 'undefined') {
    window.EnvDetector = EnvDetector;
}
```

### 使用示例

```javascript
// 页面初始化时检测环境
const env = EnvDetector.getCurrentEnvironment();
console.log('当前环境:', env);

// 小程序环境特定逻辑
if (EnvDetector.isWeChatMiniProgram()) {
    console.log('运行在微信小程序中');
    
    // 调用微信API
    EnvDetector.callWeChatAPI('miniProgram.navigateTo', {
        url: '/pages/detail/detail?id=123'
    }).then(res => {
        console.log('跳转成功:', res);
    }).catch(err => {
        console.error('跳转失败:', err);
    });
}

// 浏览器环境特定逻辑
if (env === 'browser') {
    console.log('运行在浏览器中');
    // 浏览器特定逻辑
}
```

## 总结

微信小程序H5判断是实现小程序与H5交互的基础功能，通过本文档提供的方法，您可以：

1. 准确判断当前页面是否运行在微信小程序环境中
2. 安全调用微信小程序提供的API
3. 针对不同环境提供差异化的用户体验
4. 确保代码在各种环境中的兼容性

通过合理使用这些方法，可以构建更加灵活、功能丰富的跨环境应用。
